# Planejamento da Sprint 0003

---

#### **üéØ Objetivo da Sprint**

O objetivo principal desta sprint √© **proteger a aplica√ß√£o contra acessos n√£o autorizados**, implementando um conjunto robusto e granular de regras de seguran√ßa diretamente no Firestore. Esta implementa√ß√£o √© um pilar fundamental da arquitetura BaaS (Backend as a Service) adotada pelo projeto, conforme destacado no **ADR 0000**, e garantir√° que cada papel de usu√°rio (`candidate`, `recruiter`, `admin`) possa ler e escrever apenas os dados estritamente necess√°rios para suas fun√ß√µes.

---

#### **üìö Est√≥ria de Usu√°rio a ser Atendida**

* **ID:** `TFLOW-003`
* **T√≠tulo:** Implementa√ß√£o Detalhada de Regras de Seguran√ßa no Firestore
* **Descri√ß√£o:** Como Tech Lead, quero implementar regras de seguran√ßa granulares e expl√≠citas no Cloud Firestore para que a plataforma esteja protegida, garantindo que os usu√°rios s√≥ possam interagir com os dados que lhes s√£o permitidos, em conformidade com as `roles` e os fluxos de neg√≥cio definidos.

---

#### **üìã Tarefas da Sprint**

As tarefas abaixo foram detalhadas a partir dos Crit√©rios de Aceita√ß√£o da est√≥ria `TFLOW-003` e da arquitetura geral do sistema.

##### **1. Estrutura e Fun√ß√µes Auxiliares**

* **Tarefa 1: Configurar Estrutura e Fun√ß√µes de Apoio**
  * **Descri√ß√£o:** Preparar o arquivo `firestore.rules` com a sintaxe da `rules_version = '2';`. Criar fun√ß√µes auxiliares (`helper functions`) para simplificar e reutilizar a l√≥gica de verifica√ß√£o de permiss√µes.
  * **Detalhes:**
    * Criar a fun√ß√£o `isAuthenticated()` que verifica se `request.auth != null`.
    * Criar a fun√ß√£o `isOwner(userId)` que compara `request.auth.uid` com o `userId` fornecido.
    * Criar a fun√ß√£o `isRole(role)` ou `isOneOfRoles(roles)` que l√™ o papel do usu√°rio do seu documento na cole√ß√£o `users`, conforme definido no **ADR 0011**.
        ```firestore
        // Exemplo de fun√ß√£o para verifica√ß√£o de papel
        function isRole(role) {
          return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
        }
        ```

##### **2. Implementa√ß√£o das Regras por Cole√ß√£o**

* **Tarefa 2: Implementar Regras para a Cole√ß√£o `users`**
  * **Descri√ß√£o:** Proteger os dados dos perfis de usu√°rio, garantindo que cada usu√°rio s√≥ possa modificar suas pr√≥prias informa√ß√µes e n√£o possa escalar seus privil√©gios.
  * **Crit√©rios de Aceita√ß√£o:** `AC1`
  * **Detalhes:**
    * Permitir leitura para qualquer usu√°rio autenticado.
    * Permitir escrita (`create`, `update`, `delete`) apenas se `isOwner(userId)` for verdadeiro.
    * Na opera√ß√£o de `update`, validar que o campo `role` n√£o foi modificado (`request.resource.data.role == resource.data.role`).

* **Tarefa 3: Implementar Regras para as Cole√ß√µes de Curadoria**
  * **Descri√ß√£o:** Aplicar regras para todas as cole√ß√µes de dados mestres, como `technologies`, `softSkills`, `experienceLevels`, etc..
  * **Crit√©rios de Aceita√ß√£o:** `AC3`
  * **Detalhes:**
    * Permitir leitura p√∫blica (`read`) para qualquer usu√°rio, autenticado ou n√£o.
    * Permitir escrita (`create`, `update`, `delete`) apenas para usu√°rios com o papel `admin` (`isRole('admin')`).

* **Tarefa 4: Implementar Regras para a Cole√ß√£o `vacancies`**
  * **Descri√ß√£o:** Definir as permiss√µes de acesso para a cria√ß√£o e gerenciamento de vagas.
  * **Crit√©rios de Aceita√ß√£o:** `AC2`
  * **Detalhes:**
    * Permitir leitura p√∫blica para suportar a p√°gina de vagas abertas (`TFLOW-015`).
    * Permitir escrita (`create`, `update`, `delete`) apenas para os pap√©is `recruiter` e `admin`.

* **Tarefa 5: Implementar Regras para a Cole√ß√£o `resumes` e Sub-cole√ß√µes**
  * **Descri√ß√£o:** Implementar as regras mais cr√≠ticas de privacidade, protegendo os dados sens√≠veis dos curr√≠culos dos candidatos.
  * **Crit√©rios de Aceita√ß√£o:** `AC4`
  * **Detalhes:**
    * **Leitura (resumes):** Permitir se o usu√°rio for o dono do curr√≠culo (`isOwner(resumeId)`) ou tiver a `role` de `recruiter` ou `admin`.
    * **Escrita (resumes):** Permitir `create` e `update` apenas para o dono do curr√≠culo.
    * **Leitura (recommendedVacancies):** Na sub-cole√ß√£o, permitir leitura apenas para o dono do curr√≠culo.
    * **Escrita (recommendedVacancies):** Bloquear totalmente a escrita via cliente, pois esta ser√° feita apenas pelo servi√ßo de IA com credenciais de backend.

##### **3. Testes e Valida√ß√£o**

* **Tarefa 6: Configurar e Escrever Testes para as Regras**
  * **Descri√ß√£o:** Utilizar o Emulador de Firestore e a biblioteca `firebase-rules-unit-testing` para criar um conjunto de testes que valide todas as regras implementadas.
  * **Detalhes:**
    * Configurar o ambiente de testes unit√°rios para as regras do Firestore.
    * Escrever casos de teste para o acesso de um usu√°rio **n√£o autenticado**.
    * Escrever casos de teste para o papel `candidate` (ex: pode criar/editar seu pr√≥prio curr√≠culo, mas n√£o pode criar uma vaga).
    * Escrever casos de teste para o papel `recruiter` (ex: pode criar/editar vagas e ler curr√≠culos, mas n√£o pode editar dados de curadoria).
    * Escrever casos de teste para o papel `admin` (ex: pode editar dados de curadoria).
    * Garantir que os testes cubram tanto os cen√°rios de sucesso (permitido) quanto os de falha (negado).

---

#### **‚úÖ Defini√ß√£o de "Pronto" (Definition of Done)**

A est√≥ria `TFLOW-003` ser√° considerada "Pronta" quando:

1.  Todas as regras de seguran√ßa descritas nos Crit√©rios de Aceita√ß√£o estiverem implementadas no arquivo `firestore.rules`.
2.  As fun√ß√µes auxiliares (`helper functions`) estiverem sendo utilizadas para evitar a duplica√ß√£o de l√≥gica.
3.  O conjunto de testes unit√°rios para as regras de seguran√ßa for criado e todos os testes estiverem passando.
4.  O c√≥digo for revisado (via Pull Request), aprovado e integrado √† branch principal.
5.  As regras de seguran√ßa forem implantadas no ambiente do Firebase.
6.  Uma verifica√ß√£o manual for realizada para confirmar que as permiss√µes est√£o sendo aplicadas corretamente configuradas.

---

### **üìã Checklist de Conclus√£o da Sprint**

* `[x]` **(Tarefas 1-5):** Todas as regras de seguran√ßa do `TFLOW-003` foram implementadas no arquivo `firestore.rules`.
* `[x]` **(Tarefa 1):** Fun√ß√µes auxiliares (`helper functions`) foram criadas e utilizadas para manter o c√≥digo limpo e reutiliz√°vel.
* `[x]` **(Tarefa 6):** O conjunto completo de testes unit√°rios para as regras foi criado e todos os testes est√£o passando com sucesso.
* `[x]` **(Tarefa 6):** Os testes cobrem cen√°rios para todos os pap√©is (`candidate`, `recruiter`, `admin`) e para usu√°rios n√£o autenticados.
* `[x]` O Pull Request com as altera√ß√µes foi revisado, aprovado e integrado √† branch principal.
* `[x]` As regras de seguran√ßa foram devidamente implantadas (deploy) no ambiente de desenvolvimento/produ√ß√£o do Firebase.
* `[x]` Uma verifica√ß√£o funcional manual foi realizada para confirmar a aplica√ß√£o correta das permiss√µes.
